<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Elite POS Terminal</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-gray-100 h-screen flex flex-col font-sans text-sm">

    <div id="app" class="flex flex-col h-full">
        <nav class="bg-gray-800 border-b border-gray-700 p-4 flex justify-between items-center shadow-2xl">
            <div class="flex items-center gap-8">
                <h1 class="text-xl font-black tracking-tighter text-white italic uppercase">Elite <span class="text-blue-500">POS</span></h1>
                
                <div v-if="userRole === 'ADMIN'" class="flex gap-6 border-l border-gray-700 ml-2 pl-6">
                    <a href="index.html" class="text-blue-500 font-bold uppercase text-[10px] tracking-widest">POS</a>
                    <a href="purchase.html" class="text-gray-400 hover:text-blue-400 font-bold uppercase text-[10px] tracking-widest transition-colors">New Purchase</a>
                    <a href="inventory.html" class="text-gray-400 hover:text-blue-400 font-bold uppercase text-[10px] tracking-widest transition-colors">Inventory Audit</a>
                    <a href="history.html" class="text-gray-400 hover:text-blue-400 font-bold uppercase text-[10px] tracking-widest transition-colors">History Log</a>
                </div>
            </div>

            <div class="flex items-center gap-4">
                <div class="flex items-center gap-2 bg-gray-900 p-1 rounded-xl border border-gray-700">
                    <button @click="userRole = 'CASHIER'" :class="userRole === 'CASHIER' ? 'bg-gray-700 text-white' : 'text-gray-500'" class="px-3 py-1 rounded-lg text-[10px] font-bold uppercase transition-all">Cashier</button>
                    <button @click="userRole = 'ADMIN'" :class="userRole === 'ADMIN' ? 'bg-gray-700 text-white' : 'text-gray-500'" class="px-3 py-1 rounded-lg text-[10px] font-bold uppercase transition-all">Admin</button>
                </div>
            </div>
        </nav>

        <main class="flex-grow flex overflow-hidden">
            <div class="w-3/5 p-8 overflow-y-auto">
                <div class="grid grid-cols-2 gap-6">
                    <div v-for="p in products" :key="p.id" @click="addToCart(p)"
                         :class="p.quantity > 0 ? 'bg-gray-800 border-gray-700 hover:border-blue-500 cursor-pointer shadow-xl' : 'bg-gray-800 opacity-40 grayscale cursor-not-allowed'"
                         class="p-6 rounded-2xl border-2 transition-all group relative overflow-hidden">
                        
                        <div v-if="p.quantity <= 5 && p.quantity > 0" class="absolute top-2 right-2 bg-orange-500 text-[8px] font-bold px-2 py-0.5 rounded uppercase">Low Stock</div>
                        
                        <h3 class="font-bold text-lg text-white group-hover:text-blue-400 transition-colors">{{ p.name }}</h3>
                        <div class="flex justify-between mt-4 items-end">
                            <span class="text-blue-400 font-black text-2xl">${{ p.price }}</span>
                            <span class="text-gray-500 text-[10px] font-mono uppercase">Stock: {{ p.quantity }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="w-2/5 bg-gray-800 border-l border-gray-700 flex flex-col p-6 shadow-2xl">
                <h2 class="text-lg font-black mb-4 uppercase tracking-widest text-blue-500">Current Cart</h2>
                
                <div class="flex-grow overflow-y-auto space-y-3 pr-2">
                    <div v-for="(item, index) in cart" :key="item.id" class="bg-gray-900 p-4 rounded-xl flex justify-between border border-gray-700">
                        <div>
                            <p class="font-bold text-gray-200 text-sm">{{ item.name }}</p>
                            <p class="text-xs text-blue-400 font-mono">Qty: {{ item.qty }} x ${{ item.price }}</p>
                        </div>
                        <button @click="removeFromCart(index)" class="text-red-500 text-xs font-bold px-2 hover:bg-red-900/20 rounded self-center py-1 transition-colors">Remove</button>
                    </div>
                    <div v-if="cart.length === 0" class="h-full flex items-center justify-center text-gray-600 italic">Cart is empty</div>
                </div>

                <div class="mt-6 border-t border-gray-700 pt-6 space-y-4 bg-gray-900 -mx-6 -mb-6 p-6 rounded-t-3xl shadow-inner">
                    <div class="flex justify-between text-3xl font-black text-white">
                        <span class="text-gray-400 text-sm self-center uppercase tracking-widest">Total</span>
                        <span>${{ cartTotal.toFixed(2) }}</span>
                    </div>
                    
                    <div class="space-y-1">
                        <label class="text-[10px] text-gray-500 uppercase font-bold tracking-widest">Amount Tendered</label>
                        <input v-model.number="amountPaid" type="number" placeholder="0.00" 
                               class="w-full bg-gray-800 border-2 border-gray-700 rounded-xl p-4 text-3xl font-mono text-center text-blue-400 focus:border-blue-500 outline-none transition-all">
                    </div>

                    <button @click="processSale" 
                            :disabled="amountPaid < cartTotal || cart.length === 0" 
                            class="w-full bg-blue-600 p-4 rounded-xl font-black uppercase tracking-widest shadow-lg shadow-blue-500/20 disabled:bg-gray-700 disabled:text-gray-500 transition-all active:scale-95">
                        Complete Transaction
                    </button>
                </div>
            </div>
        </main>
    </div>

    <script>
        const { createApp } = Vue;
        createApp({
            data() {
                return {
                    userRole: 'ADMIN',
                    products: [],
                    cart: [],
                    amountPaid: null
                }
            },
            computed: {
                cartTotal() { return this.cart.reduce((sum, item) => sum + (item.price * item.qty), 0); }
            },
            methods: {
                async fetchProducts() {
                    const res = await fetch('http://localhost:8080/api/products');
                    this.products = await res.json();
                },
                addToCart(product) {
                    const existing = this.cart.find(i => i.id === product.id);
                    if (existing && existing.qty < product.quantity) existing.qty++;
                    else if (!existing && product.quantity > 0) this.cart.push({ ...product, qty: 1 });
                },
                removeFromCart(index) { this.cart.splice(index, 1); },
                
                async processSale() {
                    const change = (this.amountPaid - this.cartTotal).toFixed(2);
                    
                    // Logic: Sending sale data to backend. 
                    // Backend should be adjusted to:
                    // 1. Create a Sale record
                    // 2. Deduct Product stock
                    // 3. LOG A NEW 'SALE' TRANSACTION in the inventory_transactions table
                    for (const item of this.cart) {
                        await fetch(`http://localhost:8080/api/sales?productId=${item.id}&quantitySold=${item.qty}`, {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ customerName: "Walk-in Customer", status: "PAID", user: { id: 1 } })
                        });
                    }
                    
                    alert(`Transaction Success!\nChange Due: $${change}`);
                    this.cart = []; 
                    this.amountPaid = null; 
                    this.fetchProducts(); // Refresh stock levels to see the updated numbers
                }
            },
            mounted() { this.fetchProducts(); }
        }).mount('#app')
    </script>
</body>
</html>